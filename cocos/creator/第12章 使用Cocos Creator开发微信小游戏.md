## 第12章 使用Cocos Creator开发微信小游戏

进入智能手机时代，不止是游戏，手机上的各种App也方兴未艾。评价一款App最重要的因素包括用户数量、下载数量和日活跃用户数量等。然而，有这么一款App，它取得的成绩和重要程度已经不能简单地用这些数据衡量，它就是微信。不知不觉中，微信已经悄然改变了我们的生活。在之前，我们的移动通信主要通过两个方式：语音通话和短信，虽然移动运营商也曾经推出过类似飞信这种移动通信应用，但是受限于运行商自身的考虑，都未能取得突破。微信则不同，它取得了前所未有的成功，成为了第三种移动通信方式，甚至对之前的两种通信方式构成了威胁，是一款颠覆性的产品。

借助强大的平台，微信推出了各种功能，从在朋友圈中添加推荐广告，到微信游戏的引入，通过微信好友的功能增加游戏的社交功能，著名的MOBA（Multiplayer Online Battle Arena，多人在线战术竞技类）游戏——《王者荣耀》的火爆就是一个最好的例子。除此以外，微信继续扩展着自己的功能：2017年1月9日，微信小程序平台上线，微信小程序附着在微信内，以网页的形式存在，它不用安装便可使用；2017年12月28日，万众瞩目的微信小游戏上线了，开发者可以把网页游戏嵌入到微信中，原理和微信小程序类似，都是在微信中嵌入了网页浏览器，并用浏览器打开网页应用。Cocos Creator从微信小游戏发布伊始就提供对它的支持，开发者可以通过使用Cocos Creator开发并导出微信小游戏，本章就介绍如何使用Cocos Creator开发并发布微信小游戏。

### 12.1 微信简介

微信（WeChat）是腾讯公司于2011年1月21日为移动智能终端推出的一款免费的即时通信应用。

除了常规的通信功能，微信还提供公众平台、朋友圈、消息推送等功能，用户可以通过直接搜索号码，或者通过“摇一摇”、“附近的人”等功能添加好友和关注公众平台，同时微信还支持将内容分享给好友、将不错的内容分享到朋友圈等功能。

截至2018年第一季度，微信的活跃用户已经突破了10亿，达到了10.4亿，在如此大的用户规模下，微信已经成为最具影响力的用户平台。

基于微信这个平台，腾讯开发了微信支付、微信公众号和微信小程序等功能，这些功能既扩展了微信作为一个App本身的功能，同时，也增强了微信作为平台的功能，微信平台的相关大事件时间表如下：

1）微信公众平台于2012年8月23日上线，微信公众平台主要面向名人、政府、媒体、企业等机构推出的合作推广业务。在2013年8月5日，微信公众平台被分为订阅号和服务号，运营主体是组织（比如企业、媒体、公益组织）的可以申请服务号，运营主体是组织或个人的可以申请订阅号。

2）微信游戏中心于2013年8月5日上线，微信游戏《天天爱消除》和《飞机大战》等一系列借助微信好友的社交游戏上线，微信扩展为游戏发行平台。

3）2014年3月，微信开放支付功能，移动支付从此席卷全国，已经逐渐改变人们的消费方式。

4）2016年9月21日，微信小程序开启内测，在微信生态下，腾讯云提供上线微信小程序解决方案，提供小程序在云端的技术方案

2017年1月9日，万众瞩目的微信小程序正式上线，用户可以体验到各种各样的微信小程序的开发。

5）2018年12月28日，微信小游戏上线，同步上线微信重点推出的游戏——《跳一跳》，从此，一个个微信小游戏成为用户“地铁时间”的最佳伴侣。

### 12.2 微信小程序

我们常常有这样的困扰，智能手机随着使用，会安装越来越多的应用，手机的存储不论多大都会遇到不够用的情况，这种问题能否得到解决呢？微信小程序就是一种不需要安装也可以使用的应用，对于开发者而言，它的开发难度不及App，并且门槛相对较低，能够满足简单的基础应用需求，适合生活服务类线下商铺等使用。小程序能够实现消息通知、线下扫码、公众号关联等七大功能。其中，通过公众号关联，用户可以实现公众号与小程序之间相互跳转。由于都是采用网页嵌入的方法，因此从原理上，两者是类似的，系出同源，本节介绍微信小游戏的“哥哥”——微信小程序。

#### 12.2.1 微信小程序简介

微信小程序是腾讯内部针对微信的第三个内部项目，是一种不需要安装就可以使用的应用，它实现了应用触手可及的梦想，用户可以通过“扫一扫”或者名称搜索找到相关应用即可打开，同时它也实现了用完即走的理念，用户不用关心是否安装太多应用的问题。应用将无处不在，随时可用，但又无须安装卸载。

2017年，微信小程序一共经历了10多次的更新，微信小程序的目标也逐步转变为“把微信从连接人和人，变成连接人和服务”。微信小程序经历的变化如下：

1）2016年9月21日，微信小程序正式开启内测。

2）2017年1月9日，第一批微信小程序正式上线，用户可以体验到各种各样第三方提供的微信小程序。

3）2018年1月18日，微信提供了电子化的侵权投诉渠道，用户或者企业可以在微信公众平台以及微信客户端入口进行投诉。

4）2018年1月25日，微信团队在“微信公众平台”发布公告称，“从移动应用分享至微信的小程序页面，用户访问时支持打开来源应用。同时，为提升用户使用体验，开发者可以设置小程序菜单的颜色风格，并根据业务需求，对小程序菜单外的标题栏区域进行自定义。

5）2018年3月，微信正式宣布小程序广告组件启动内测，内容还包括第三方可以快速创建并认证小程序、新增小程序插件管理接口和更新基础能力，开发者可以通过小程序来赚取广告收入。除了公众号文中、朋友圈广告以及公众号底部的广告位都支持小程序落地页投放广告外，小程序广告位也可以直达小程序。

开发一款微信小程序，包括注册、信息完善、开发、提交审核和发布等步骤，如图12-1所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231730.jpg)

图12-1 微信小程序开发接入流程

#### 12.2.2 申请开发账号

想要开发一款微信小程序，你首先要有一个微信公众平台账号，通过在微信公众平台的官网进行注册，地址：[https://mp.weixin.qq.com/wxopen/waregister?action=step1](http://mp.weixin.qq.com/wxopen/waregister?action=step1)，如图12-2所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231731.jpg)

图12-2 申请小程序开发者账号

根据如图12-2所示的指引填写信息和提交相关资料，就可以注册微信小程序账号。注册完毕后，就可以登录小程序管理平台，管理小程序的相关信息，首先要同意开发者的相关协议，如图12-3所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231732.jpg)

图12-3 开发者服务协议

点击页面左侧菜单中的“开发→基本配置”就可以进入开发者协议，点击同意《微信公众平台开发者服务协议》就可以成为微信开发者，进入小程序后台管理页面，如图12-4所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231733.jpg)

图12-4 小程序后台管理平台

其中需要说明的是AppID，相当于小程序平台的一个身份证，后续你会在很多地方要用到AppID（注意这里要区别于服务号或订阅号的AppID）。

#### 12.2.3 微信小程序开发工具

开发一款微信小程序，需要微信小程序的开发工具，开发微信小程序需要使用官方提供的开发工具，下载地址为：[https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html?t=2018614](http://developers.weixin.qq.com/miniprogram/dev/devtools/download.html?t=2018614)。

开发工具目前支持Windows（包括32位和64位）以及Mac系统等平台，本书成书之时，微信小程序开发工具的最新版本为2.1.0版，同时支持微信小程序和微信小游戏的开发。

在微信小程序开发工具中，可以实现小程序的代码开发、程序调试运行预览及项目的发布等功能。具体的小程序开发工具的更多功能，可以参见开发者文档，文档地址为[https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html?t=2018614](http://developers.weixin.qq.com/miniprogram/dev/devtools/download.html?t=2018614)。

下载完开发工具后，按照指引安装即可，安装完成后双击微信小程序开发工具，就可以运行了，扫描二维码登录后，运行效果如图12-5所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231734.jpg)

图12-5 微信开发者工具启动页面

开发者工具提供两种开发模式：

（1）公众号网页项目。选择公众号网页调试，将直接进入公众号网页项目调试界面，在地址栏输入URL，即可调试该网页的微信授权以及微信JS-SDK功能。

（2）小程序项目。选择小程序调试，将进入小程序本地项目管理页，可以新建、删除本地的项目，或者选择进入已存在的本地项目。

选择“小程序项目”就可以开发微信小程序了。开发一个微信小程序项目，需要三个条件：

1）需要一个小程序AppID，没有AppID的话可以在本地使用，是体验版本，不能上传和真机预览。

2）登录的微信号，需要是AppID的开发者。

3）选择空目录，或者选择非空目录，但是目录下要存在项目启动文件app.js和项目配置文件project.config.json。

开发者工具允许同时打开多个项目，可以新建项目，也可以选择目录去打开项目，还可以通过最近打开项目去打开一个过去打开过的项目。这里新建一个项目，如图12-6所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231735.jpg)

图12-6 微信小程序开发工具

小程序开发工具包含菜单栏、工具栏、模拟器、编辑器和调试器五大部分。菜单栏和工具栏包含开发工具所具有的功能。工具栏中间，可以选择普通编译，也可以新建并选择自定义条件进行编译和预览。通过切后台按钮，可以模拟小程序进入后台的情况。工具栏上提供了清缓存的快速入口。可以便捷地清除工具上的文件缓存、数据缓存，还有后台的授权数据，方便开发者调试。工具栏右侧是开发辅助功能的区域，在这里可以上传代码、申请测试、上传腾讯云、查看项目信息。在工具栏上点击鼠标右键，可以打开工具栏管理。

模拟器可以模拟小程序在微信客户端的表现。小程序的代码通过编译后可以在模拟器上直接运行。开发者可以选择不同的设备，也可以添加自定义设备来调试小程序在不同尺寸机型上的适配问题。在模拟器底部的状态栏，可以直观地看到当前运行的小程序的场景值、页面路径及页面参数，如图12-7所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231736.jpg)

图12-7 模拟器分辨率设置

在小程序上方的开发工具中点击左上角的“模拟器/调试器”按钮，可以使用独立窗口显示模拟器/调试器。

#### 12.2.4 微信小程序程序结构

新建一个空的微信小程序项目，可以看到微信小程序项目的结构，如图12-8所示

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231737.jpg)

图12-8 微信小程序结构

首先来看app.json文件，这个文件包含了小程序的全局配置，包括了小程序的所有页面路径、界面表现、网络超时、底部tab等。app.json的结构代码如下所示。

```
        {
            "pages":[
                "pages/index/index",
                "pages/logs/logs"
            ],

            "window":{
                "backgroundTextStyle":"light",
                "navigationBarBackgroundColor": "#fff",
                "navigationBarTitleText": "WeChat",
                "navigationBarTextStyle":"black"
            }
        }
```

其中pages字段用于描述当前小程序所有页面路径，这是为了让微信客户端知道当前你的小程序页面定义在哪个目录。window字段用于描述小程序所有页面的顶部背景颜色、文字颜色。

project.config.json主要用来保存项目的个性化配置，例如界面颜色、编译配置等，当你重新安装工具或者换电脑工作时，你只要载入同一个项目的代码包，开发者工具就自动会帮你恢复到你开发项目时的个性化配置，其中会包括编辑器的颜色、代码上传时自动压缩等一系列选项，见代码清单12-1。

代码清单12-1 project.config.json文件内容

```
        {
            "description": "项目配置文件。",
            "packOptions": {
                "ignore": []
            },

            "setting": {
                "urlCheck": true,
                "es6": true,
                "postcss": true,
                "minified": true,
                "newFeature": true
            },
            "compileType": "miniprogram",
            "libVersion": "2.0.4",
            "appid": "touristappid",
            "projectname": "test",
            "condition": {
                "search": {
                    "current": -1,
                    "list": []
                },
                "conversation": {
                    "current": -1,
                    "list": []
                },

                "game": {
                    "currentL": -1,
                    "list": []
                },

                "miniprogram": {
                    "current": -1,
                    "list": []
                }
            }
        }
```

从事过网页编程工作的人都知道，网页编程采用的是HTML + CSS + JavaScript这样的组合，其中HTML用来描述当前这个页面的结构，CSS用来描述页面的样式，JavaScript通常用来处理这个页面和用户的交互。同样的道理，在小程序中也有同样的角色，其中WXML充当的就是类似HTML的角色。

pages文件夹下包含的页面，都包含一个WXML文件，如pages/index文件下的index. wxml，代码如下所示。

```
        <! --index.wxml-->

        <view class="container">
            <view class="userinfo">
                <button wx:if="{{! hasUserInfo && canIUse}}"
                  open-type="getUserInfo"
                  bindgetuserinfo="getUserInfo">获取头像昵称</button>
                <block wx:else>
                    <image bindtap="bindViewTap" class="userinfo-avatar"
                      src="{{userInfo.avatarUrl}}" mode="cover"></image>
                    <text class="userinfo-nickname">{{userInfo.nickName}}</text>
                </block>
            </view>
            <view class="usermotto">
                <text class="user-motto">{{motto}}</text>
            </view>
        </view>
```

WXML和HTML很相似但略有不同，首先标签名字不一样，往往写HTML的时候会用到的标签是“div”“p”“span”。开发者在写一个页面的时候可以根据这些基础的标签组合出不一样的组件，例如日历、弹窗等。小程序的WXML用的标签是“view”“button”“text”等，这些标签就是小程序给开发者封装好的基本能力，还提供了地图、视频、音频等组件。另外WXML多了一些wx:if这样的属性以及 {{ }} 这样的表达式。在网页的一般开发流程中，我们通常会通过JavaScript操作DOM（对应HTML的描述产生的树），以引起界面的一些变化响应用户的行为。

除HTML外，还有CSS，下面就是微信小程序中的CSS-WXSS，在每个页面下也有对应的WXSS文件，如pages/index文件下的index.wxss，代码如下所示。

```
        /＊＊index.wxss＊＊/

        .userinfo {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .userinfo-avatar {
            width: 128rpx;
            height: 128rpx;
            margin: 20rpx;
            border-radius: 50%;
        }

        .userinfo-nickname {
            color: #aaa;
        }

        .usermotto {
            margin-top: 200px;
        }
```

同样的，WXSS也在CSS的基础上进行了扩展和修改，首先新增了尺寸单位。在写CSS样式时，开发者需要考虑到手机设备的屏幕会有不同的宽度和设备像素比，采用一些技巧来换算一些像素单位。WXSS在底层支持新的尺寸单位rpx，开发者可以免去换算的烦恼，交给小程序底层来换算即可。由于换算采用浮点数运算，所以运算结果会和预期结果有一点点偏差。WXSS提供了全局的样式和局部样式，和前面介绍的app.json、page.json的概念相同，你可以写一个app.wxss作为全局样式，以作用于当前小程序的所有页面，局部页面样式page.wxss仅对当前页面生效。

最后，一个页面里还有对应的逻辑，在javascript文件中，如pages/index文件下的index.js，见代码清单12-2。

代码清单12-2 index.js文件内容

```
        //index.js
        //获取应用实例
        const app = getApp()

        Page({
            data: {
                motto: 'Hello World',
                userInfo: {},
                hasUserInfo: false,
                canIUse: wx.canIUse('button.open-type.getUserInfo')
            },

            //事件处理函数
            bindViewTap: function() {
                wx.navigateTo({
                    url: '../logs/logs'
                })
            },

            onLoad: function () {
                if (app.globalData.userInfo) {
                    this.setData({
                        userInfo: app.globalData.userInfo,
                        hasUserInfo: true
                    })
                } else if (this.data.canIUse){
                    // 由于getUserInfo是网络请求，可能会在Page.onLoad之后才返回
                    // 所以此处加入callback以防止这种情况

                    app.userInfoReadyCallback = res => {
                        this.setData({
                            userInfo: res.userInfo,
                            hasUserInfo: true
                        })
                    }
                } else {
                    // 在没有open-type=getUserInfo版本的兼容处理
                    wx.getUserInfo({
                        success: res => {
                            app.globalData.userInfo = res.userInfo
                            this.setData({
                                userInfo: res.userInfo,
                                hasUserInfo: true
                            })
                        }
                    })
                }
            },
            getUserInfo: function(e) {
                console.log(e)
                app.globalData.userInfo = e.detail.userInfo
                this.setData({
                    userInfo: e.detail.userInfo,
                    hasUserInfo: true
                })
            }
        })
```

上述JS文件主要包含和用户交互的逻辑，包括用户的点击和获取用户位置等逻辑，可以在JavaScript中调用丰富的程序api来获取用户信息并进行本地存储和微信支付等。

#### 12.2.5 发布和上线

发布游戏前的主要工作包括：用户身份完善、程序预览和上传代码等。

管理员可在小程序管理后台统一管理项目成员（包括开发者、体验者及其他成员），设置项目成员的权限（包括开发者/体验者权限、登录小程序管理后台、开发管理、查看小程序数据分析等）。

使用开发工具可以预览小程序，帮助开发者检查小程序在移动客户端上的真实表现。点击开发者工具顶部操作栏的预览按钮，开发工具会自动打包当前项目，并上传小程序代码至微信的服务器，成功之后会在界面上显示一个二维码。使用当前小程序开发者的微信扫码即可看到小程序在手机客户端上的真实表现。

点击开发者工具顶部操作栏的上传按钮，填写版本号及项目备注，需要注意的是，这里的版本号及项目备注是为了方便管理员检查版本，开发者可以根据自己的实际要求来填写这两个字段。

小程序的版本包括开发版本、审核中版本和线上版本等。

在开发者工具中上传了小程序代码之后，依次单击“小程序管理后台→开发管理→开发版本”找到提交上传的版本。在开发版本的列表中，单击“提交审核”，按照页面提示，填写相关的信息，即可以将小程序提交以接受审核。需要注意的是，开发者应严格测试版本之后再提交审核，审核多次不通过，可能会影响后续的工作。审核通过之后，管理员的微信中会收到小程序通过审核的通知，此时依次单击“小程序管理后台→开发管理→审核版本”可以看到通过审核的版本。

### 12.3 微信小游戏

微信小游戏脱胎于微信小程序，也可以理解为它是一种特殊的微信小程序。2017年12月28日，微信更新的版本开放了微信小游戏，并开放了微信小游戏的官方文档和开发者工具。2018年3月份下旬，微信小游戏类目终于开放测试，开发者可以在注册小程序账号后，申请游戏类目开发和调试。

目前微信小游戏开放支持微信社交关系链，开发者可以借助这个功能开发好友PK、排行榜竞技和微信群互动等功能。当然，开发这些功能的前提是要获得开发者工具对于微信数据域的支持。同时微信小游戏也开启了计费，目前移动游戏发行需要获得发行版号：“根据国家政策要求，国内个人及非个人（企业、个体工商户、政府、媒体、其他组织）都可以注册小游戏。在版本提审时，非个人开发者需提供《广电总局版号批文》《文化部备案信息》《计算机软件著作权登记证书》《游戏自审自查报告》；个人开发者需提供《计算机软件著作权登记证书》《游戏自审自查报告》等。”没有版号的小游戏是无法开放支付功能的。

微信小游戏开放后，很多小游戏通过微信快速传播，其中比较火爆的就包括《跳一跳》等游戏，微信小游戏由于其轻量化的特点，可以占据用户的碎片时间，同时微信小游戏还不需安装，可以随时打开玩，这些特点都使得微信小游戏广受玩家好评。《跳一跳》的游戏截图如图12-9所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231738.jpg)

图12-9 小游戏《跳一跳》

#### 12.3.1 微信小游戏简介

从技术的角度说，微信小游戏是在微信小程序的基础上添加了游戏库API。小游戏只能运行在小程序环境中，所以小游戏既不是原生游戏，也不完全等同于HTML5游戏。但实际上小游戏面向的就是HTML5游戏开发者，为了让HTML5游戏可以尽可能低成本地移植，小游戏尽可能复用了WebGL、JavaScript等源自浏览器的HTML5技术。可以说小游戏是使用HTML5技术搭建，具有原生体验的微信内游戏产品。采用这种技术的优势就是相比于原生游戏，微信小游戏可以在微信内形成闭环，且不容易被篡改或者增加广告。

从移植性上讲，无论是哪个游戏引擎开发的HTML5游戏都可以很容易地移植到微信小游戏上，由于目前HTML5相关的游戏开发技术和工具都比较完善，所以有一批产品可以通过简单修改快速上线。目前Cocos Creator、白鹭引擎Egret及Laya引擎都已经支持微信小游戏的开发和导出，引擎封装出的高层接口可以大大降低开发者的开发门槛，缩短项目周期。

微信开放平台这个优秀的入口，及其微信小游戏自身具有的即点即玩的便捷性，给微信小游戏以极大的潜能。利用好微信的社交生态来获取新用户，将在小游戏的设计中占据非常重要的地位。可以看到，第一批十六款游戏中，除了《跳一跳》有微信闪屏的入口之外，其他的小游戏入口都藏得比较深，所以流量来源主要不是推荐榜，而是社交传播。这点和市面上多数导用户、洗用户、滚服合服的游戏设计思路是不同的。

微信小游戏的结构如图12-10所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231739.jpg)

图12-10 微信小游戏结构

小游戏的运行环境其实是微信的原生环境，游戏的JavaScript代码并不是通过浏览器来执行的，而是通过JavaScript VM层独立的JavaScript引擎来执行的。在Android平台使用Google的V8引擎，在iOS上则使用苹果的JavaScript Core引擎。通过JavaScript绑定技术，对于JavaScript的函数调用可以通过bridge调用到底层的原生接口来实现，微信小游戏环境用的就是这样的技术，将iOS/Android原生平台实现的渲染、用户、网络、音视频等接口绑定为JavaScript接口。除此之外，微信小游戏团队还提供了Adapter层来降低不同平台的移植成本和处理兼容性问题，但是需要注意的是，目前Adapter层已经不再维护，因此推荐大家使用游戏引擎来开发微信小游戏，因为适配工作一般游戏引擎都可以完成。

游戏引擎为游戏开发者提供了高层API封装、资源加载适配、各种事件的处理适配、多媒体的处理、窗口和输入框适配等功能。高效率的编辑器带来开发成本的降低；低门槛降低了人力成本；高兼容性和稳定的性能降低了维护成本。

#### 12.3.2 微信小游戏的开发

在微信小程序开发工具中新建一个空的微信小游戏项目，可以发现它的项目结构和微信小程序略有不同，如图12-11所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231740.jpg)

图12-11 微信小游戏项目结构

其中，project.config.json和微信小程序中的配置文件一样，也是用来保存项目的自定义配置，例如界面颜色、编译配置等。

game.json用来进行游戏相关属性的配置，开发者工具和游戏客户端都需要读取这个配置，完成界面的渲染和属性配置。代码如下所示。

```
        //game.json
        {
            "deviceOrientation": "portrait",

            "networkTimeout": {
                "request": 5000,
                "connectSocket": 5000,
                "uploadFile": 5000,
                "downloadFile": 5000
            }
        }
```

其中每个属性的说明见表12-1。

表12-1 game.json属性说明

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231741.jpg)

game.js是微信小游戏的入口文件，代码如下所示。

```
        //game.js
        import './js/libs/weapp-adapter'
        import './js/libs/symbol'

        import Main from './js/main'

        new Main()
```

这个文件就是游戏的入口，在这里，调用js文件夹下的main.js文件中的游戏主要逻辑，main.js文件下的restart函数处理游戏的开始逻辑，代码如下所示。

```
        //main.js
        restart() {
            databus.reset()

            canvas.removeEventListener(
                'touchstart',
                this.touchHandler
            )

            this.bg = new BackGround(ctx)
            this.player = new Player(ctx)
            this.gameinfo = new GameInfo()
            this.music = new Music()

            this.bindLoop = this.loop.bind(this)
            this.hasEventBind = false

            // 清除上一局的动画
            window.cancelAnimationFrame(this.aniId);

            this.aniId = window.requestAnimationFrame(
                this.bindLoop,
                canvas
            )
        }
```

微信小游戏建立在Canvas画布上，这个画布调用的是微信API，在libs文件夹下的weapp-adapter.js（即微信官方提供的adapter适配文件）中创建Canavs，代码如下所示。

```
        //创建画布
        function Canvas() {

            var canvas = wx.createCanvas()

            canvas.type = 'canvas'

            canvas.__proto__.__proto__ = new _HTMLElement2.default('canvas')

            var _getContext = canvas.getContext
            canvas.getBoundingClientRect = function () {

                var ret = {
                    top: 0,
                    left: 0,
                    width: window.innerWidth,
                    height: window.innerHeight
                }
                return ret
            }

            return canvas
        }
```

wx.createCanvas函数创建的是上屏的画布，之后创建离屏的画布。这里创建画布并把画布暴露出来，然后就可以在画布上进行绘制，需要注意的是离屏的画布，只会在画布上显示，并不会在屏幕上显示，也就是同时只会显示一个画布。绘制的方法如下代码所示。

```
        //创建画布
        var context = canvas.getContext('2d')
        context.fillStyle = 'red'
        context.fillRect(0, 0, 100, 100)
```

wx.createImage函数用来创建图片、加载图片，可以加载本地或者网络图片。只有当image绘制到当前的画布上时，才会显示出来。创建图片并加载图片的方法如下代码所示。

```
        //加载图片
        var image = wx.createImage()

        image.onload = function () {
            console.log(image.width, image.height)
            context.drawImage(image, 0, 0)
        }
        image.src = 'test.png'
```

一个画布只有被绘制出来时才会显示在当前屏幕上，代码如下所示。

```
        //显示画布
        var screenContext = screenCanvas.getContext('2d')
        screenContext.drawImage(offScreenCanvas, 0, 0)
```

这些使用wx API模拟BOM和DOM的代码组成的库，我们称为Adapter。顾名思义，这是对基于浏览器环境的游戏引擎在小游戏运行环境下的适配层，使游戏引擎在调用DOM API和访问DOM属性时不会产生错误。Adapter是一个抽象的代码层，并不特指某一个适配小游戏的第三方库，每位开发者都可以根据自己的项目需要实现相应的Adapter。官方实现了一个Adapter为weapp-adapter，并提供了完整的源码，供开发者使用和参考。需要强调的是，weapp-adapter对浏览器环境的模拟是不完整的，仅针对游戏引擎可能访问的属性和调用的方法进行了模拟，且不保证所有游戏引擎都能通过weapp-adapter顺利无缝接入小游戏。微信官方目前将weapp-adapter提供给开发者，更多是作为开发的参考，开发者可以根据需要在weapp-adapter的基础上进行扩展，以适配自己项目使用的游戏引擎。小游戏基础库只提供wx.createCanvas和wx.createImage等wx API常用的JavaScript方法。在此之上的weapp-adapter是为了让基于浏览器环境的第三方代码更快地适配小游戏运行环境的适配层，并不是基础库的一部分。更准确地说，可以将weapp-adapter和游戏引擎都视为第三方库，需要开发者在小游戏项目中自行引入。需要强调的是，目前weapp-adapter只是作为一个参考提供给开发者，微信官方推荐使用相关的游戏引擎进行开发。

#### 12.3.3 使用Cocos Creator导出微信小游戏项目

对于绝大部分开发者来说，都会将微信小游戏平台当作一个平台来处理，也就是说它和iOS、Android以及HTML5一样是一个发布平台。所以比起直接使用微信小游戏开发工具进行开发，一般的流程是在引擎中开发游戏项目，待开发调试完成后，再通过引擎工具导到指定平台上进行测试和调试，最后通过微信小游戏开发工具进行提交。

要从Cocos Creator导出微信小游戏项目，首先要在Cocos Creator中配置微信小游戏戏开发工具的路径，可在Cocos Creator中的“偏好设置-原生开发环境”中进行设置，如图12-12所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231742.jpg)

图12-12 配置微信小游戏开发工具

在“项目-构建发布”中可以导出微信小游戏项目，在构建发布面板中，选择发布平台为“Wechat Game”，设置设备方向、AppID、调试模式等，最后点击“构建”按钮即可。需要说明的是，默认的AppID为游客AppID“wx6ac3f5090a6b99c5”，如果需要发布自己的微信小游戏需要在微信开发者平台申请独立的AppID，微信小游戏的构建发布界面如图12-13所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231743.jpg)

图12-13 构建发布界面

点击“构建”按钮，构建发布面板上方的进度条走完，并显示“complete”，表示构建完成，此时直接点击运行即可自动调用微信开发者工具，并显示正确的场景效果。如果没有自动打开微信开发者工具，或者没有自动打开游戏项目，可以使用微信开发者工具在项目路径下的build/wechatgame作为项目目录创建小游戏体验项目，调用的微信开发者工具如图12-14所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231744.jpg)

图12-14 导出微信小游戏项目

#### 12.3.4 微信小游戏的资源管理

微信小游戏对于资源管理有特殊的限制，所以并不是所有使用Cocos Creator开发的游戏都可以导到微信小游戏，微信小游戏和一般的浏览器网页游戏不同的是：

1）小游戏的包内体积不能够超过4MB，包含所有代码和资源，额外的资源必须通过网络请求下载。

2）对于从远程服务器下载的文件，小游戏环境没有浏览器的缓存以及过期更新机制。

3）对于小游戏包内资源，小游戏环境内并不是按需加载的，而是一次性加载所有包内资源，然后再启动页面。

4）不可以从远程服务器下载脚本文件。

对于比较大的游戏，做法是在游戏包内保存脚本文件，其他资源都通过热更新的方式远程下载。Cocos Creator已经提供了远程下载的解决方案，第15章将会详细介绍Cocos Creator中的热更新。微信小游戏API中，提供了wxDownloader对象，设置成REMOTE_SERVER_ROOT属性后，引擎下载逻辑如图12-15所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231745.jpg)

图12-15 下载微信小游戏资源逻辑

逻辑开始后，首先检查资源是否在包内，不存在则查询本地资源，然后查询本地缓存资源，如果没有缓存则从远程服务器下载，下载后保存到小游戏缓存内供再次访问时使用。

在浏览器中始终遵循按需加载的原则，执行到加载的标签或者脚本，才会去进行网络请求并加载内容。而在小游戏中，会首先下载提交的完整游戏包，再运行开始文件game.js来启动游戏。所谓完整游戏包，也就是开发者在微信开发者工具中所导入的资源，不管项目是否需要这些资源，在玩家打开小游戏时，资源都会被完整下载。所以为了首场景加载的体验，我们应该尽可能减小自己的小游戏包体，将可以按需加载的资源放在远程服务器上，用脚本进行加载。

微信内小游戏的文件存储空间是一个沙盒结构，它按照用户和游戏来划分。所有文件系统接口，都是在独立的文件沙盒环境中执行的，所有的文件目录也是相对于沙盒环境的，所以不用担心不同小游戏或者不同用户之间的文件冲突。只要游戏开发者和用户保证wxDownloader. REMOTE_SERVER_ROOT路径下的资源相对路径与Cocos Creator发布的资源相对路径一致，那么再次访问同一个资源时，就会在小游戏的文件沙盒环境中找到对应的文件。

当开启引擎的md5Cache功能后，文件的URL会随着文件内容的改变而改变。首先，构建时勾选md5Cache功能，将小游戏发布包中的资源文件夹完整地上传到服务器，然后删除发布包内的资源文件夹，在构建发布面板中设置远程服务地址。在测试阶段，需要在本地服务器设置，在微信开发者工具中打开详情界面，勾选项目设置中的不检查安全域名、TLS版本及HTTPS证书选项。

在发布设置面板中有一个“Source Maps”选项。开发者打包过程中引擎会将游戏代码压缩为单一文件，如果选择发布模式，还会进一步混淆并合并代码。这样就会导致调试过程中无法正确使用原始用户脚本进行调试，会加大调试的难度，要避免这种情况可在发布面板中勾选“Source Maps”。同时，还要注意，必须将微信开发者工具中的ES6转ES5选项去掉，否则开发者工具会在原始脚本内容上多包一层闭包，你之前生成的“Source Map”也就失效了。

#### 12.3.5 接入微信小游戏的子域

微信小游戏为了保护其社交关系链数据，增加了子域的概念，子域又叫开放数据域，是一个单独的游戏执行环境。子域项目工程通过微信API获取用户数据来获得排行榜等功能项目，子域中的资源、引擎、程序都和主游戏完全隔离，相当于另外一个独立的页面，开发者只有在子域中才能访问微信提供的wx.getFriendCloudStorage() 和wx.getGroupCloudStorage() 两个API，用于实现一些例如排行榜的功能。由于子域只能在离屏画布sharedCanvas上渲染，因此需要我们把sharedCanvas绘制到主域上。

接入子域项目的具体步骤包括：

1）首先在主域项目的构建发布面板中填入子域代码目录，该目录是子域构建后所在的路径，并且这个路径需要放在主域构建目录下，如图12-16所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231746.jpg)

图12-16 主域项目的发布设置

该步骤会帮助用于修改发布的game.json的设置，见代码清单12-3。

代码清单12-3 game.json

```
        //game.json
        {
            "deviceOrientation": "landscape",
            "subContext": "wx-open-data-project",
            "networkTimeout": {
                "request": 5000,
                "connectSocket": 5000,
                "uploadFile": 5000,
                "downloadFile": 5000
            }
        }
```

2）在子域项目的构建发布面板中的渲染式中选择canvas或自动模式，并选择小游戏子域工程，把当前工程打包成子域可用的文件，如图12-17所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231747.jpg)

图12-17 子域项目的发布设置

3）发布路径设置为与主域中填入子域代码目录相同的路径，即指定到主域项目工程的发布包目录下，游戏名称必须和主域项目中设置的“子域代码目录”名称一致。或者可以选择不修改发布路径，在子域项目构建完成后手动将发布包复制到发布目录下。

4）在主域项目工程中点击“运行”按钮以调用微信开发者工具，之后的调试和发布流程和一般的微信小程序或微信小游戏相同。

Cocos Creator 2.0.1版本中，对于子域部分做了优化，需要在主域中创建一个节点作为开放数据域容器，需要添加微信子内容视图组件——WXSubContextView，这个组件用于设置开放数据域视图以及更新开放数据域贴图，这个节点的宽高比就是开放数据域设计分辨率的宽高比。和之前的版本不一样的地方包括：

1）可以自由控制开放数据域的尺寸，降低分辨率提高性能和分辨率优化效果都可以在子域里完成。

2）开放数据域的内容直接被缩放到主域的容器节点区域内，只要宽高比一致就不会产生拉伸。一般情况下，开放数据域的视窗是固定的。

3）开放数据域的事件响应由游戏引擎处理。当场景切换后，分辨率改变，这时候要调用updateSubContextViewport接口来更新子域中的窗口参数，这样事件可以映射到窗口中。

4）开放数据域的贴图更新由引擎处理。当开放数据域被唤起后，只要加载成功，开放数据域贴图就开始更新到主域并显示，之后每帧都会更新贴图，当需要性能优化时，也可以将enabled设置为false来禁止每帧更新。

5）在2.0.0版本以后，开放数据域项目中只可以选择Canvas渲染，另外Canvas渲染目前只支持如下组件的渲染：Sprite、Label、Graphics、Mask及UI组件。

6）发布项目时，主项目的构建发布和1.0版本没有区别，但子域项目发布有变化，发布界面如图12-18所示。

![img](https://gitee.com/nlpleaf/PicGo/raw/master/20200630231748.jpg)

图12-18 2.0.1版本子域项目的发布设置

需要注意的是，发布路径设置为与主域当中的相同路径，也就是说要发布到主域项目工程的发布包目录下，游戏名称需要和主域项目中设置的名称一致。另外一方面，也可以不修改发布路径，在开放数据域项目构建完成后手动将发布包复制到主域项目的发布包目录下。

7）需要注意的是，目前要先发布主域再发布开放数据域，因为如果先发布开放数据域再发布主域项目，那么开放数据域的发布代码会被覆盖。

### 12.4 本章小结

本章首先介绍了微信开放平台，接着介绍了微信小程序的开发和原理，然后进一步介绍了微信小游戏的开发原理和开发的具体步骤。通过本章，读者可以学到如何通过Cocos Creator快速开发一款微信小游戏。

微信庞大的用户量和微信小游戏本身随玩随走的特性，注定为开发者带来巨大的机遇，然而，开发微信小游戏并不仅仅是简单的移植或者发布，作为游戏设计者应该更多地考虑微信平台的特点和用户需求、体验，开发出专属微信平台的游戏佳作。